# パケット仕様
## 基本構造
1byte中、先頭3ビットをIDとして使う。後ろ5ビットをパターンとして使う。
IDはデバイスごとに決め打ちにする。
また、後ろ5ビット中先頭2ビットを点滅・グローのフラグにし、残りを色のIDに割り当てる。

````
|----3bit-----|----5bit----|
|--Device ID--|---Pattern--|
````

Master・Slaveともにこのパケット仕様で通信を行う。
よって、アプリからもこの形式でMasterにデータを送る。

### Device ID
NWパケット（後述）によって設定されるデバイス固有のID。

### Pattern
````
|--2bit--|-----3bit------|
|--Flag--|---Pattern ID--|
````

グローの立ち上がりは0.5秒、点滅の周期は1秒とする。

- Flag
	- 点灯するパターンを示す。
		- 00...点灯（グロー）
		- 01...グロー+点滅
		- 10...消灯
		- 11...未定義
		（11の場合は）
- Pattern ID
	- 点灯する色を示す。
		- 000...Red
		- 001...Green
		- 010...Blue
		- 011...Orange
		- 100...Yellow
		- 101...Purple
		- 110...Indigo
		- 111...White

# 伝搬アルゴリズム
考慮すべきこととして、どうタイミングを合わせてデバイスを駆動させるか。
また、どのポートからパケットをフォワードするかを考える必要がある。

デバイスは3つのポートを常に監視する。
監視のタイミングが微妙にずれた時、パケットを受信できるかは要検証。（複数のポートが同時に通信することができるか？）

## アルゴリズム草案
Controlパケットと呼ばれるパケットを用いてパケットの伝搬を行う。
Controlパケットの形式は次のとおりである。

````
|-----3bit------|--2bit--|------3bit------|
|---Device ID---|--Flag--|--Control flag--|
````

ControlパケットはFlagビットが常に`11`となる。
また、Control flagに応じてパケットの種類が異なる。（他のビットパターンは予約）

- Control flag
	- 000...NWパケット
	- 001...RSTパケット
	- 010...ACCパケット
	- 011...DNYパケット

### NWパケット
NWパケットはネットワークを構築するためのパケットである。
SlaveデバイスのデバイスIDを決定するために用いる。

NWパケットは次の手順で処理が行われる。

1. MasterはアプリからNWパケット`00011000`を受信する。
2. Masterはポート0, 1, 2に対してそれぞれ`00111000`, `01011000`, `01111000`を送信する。
3. NWパケットを受信したSlaveはパケットに含まれるDevice IDを自分のIDに設定し、受信ポート以外のポートからDevice IDをインクリメントしてフォワードする。フォワード先からEchoパケットが帰ってきた場合、ポートとDevice IDの対応を記録する。
4. すでにDevice IDが設定されているSlaveはパケットを破棄し、Echo拒否パケットを返信する。
5. n秒後の時点でDevice IDが設定できたデバイスをディスプレイとして用いる。

備考として、n=5秒であれば8台すべてのデバイスにIDを振れると思われる。
また、4.の条件により、閉路が生まれることなく二分木を構築することが可能である。

### RSTパケット
RSTパケットを受け取ったデバイスは自分のデバイスIDを無効にする。
また、他のポートにRSTパケットをフォワードする。
Device IDは常に`000`となる。

RSTパケットを受信したデバイスは、NWパケットによるデバイスIDの付与に再び対応可能な状態になる。
ネットワークを作りなおす時に利用する。

### ACCパケット
NWパケットをフォワードした先のデバイスにデバイスIDの付与が受理した時に返信されるパケット。
デバイスID部分はフォワード先のデバイスに送ったデバイスID。

例：
`00111010`...デバイスID`001`としてフォワードしたパケットが受理された。

### DNYパケット
NWパケットをフォワードした先のデバイスにすでにデバイスIDが付与されていた場合に返信されるパケット。
デバイスID部分はフォワード先のデバイスに送ったデバイスID。

例：
`00111011`...デバイスID`001`としてフォワードしたパケットが拒否された

### 伝搬アルゴリズム
デバイスはパケットを受け取った時、自分宛てのパケットの場合LEDをFlag及びColorビットに応じて駆動させる。
一方、自分宛てではなかった時、隣接するデバイスのIDが大きい方へフォワードする。
